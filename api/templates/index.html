<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask For Data - Côte d'Ivoire</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff7900;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-card {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-green-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-green-500 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Ask For Data</h1>
                        <p class="text-sm text-gray-600">Statistiques de la Côte d'Ivoire</p>
                    </div>
                </div>
                <button id="catalogBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    <i class="fas fa-list mr-2"></i>Catalogue
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Search Section -->
        <div class="max-w-4xl mx-auto mb-8">
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">
                    <i class="fas fa-search mr-2 text-orange-500"></i>
                    Posez votre question
                </h2>
                <div class="flex flex-col space-y-4">
                    <textarea 
                        id="queryInput" 
                        rows="3"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-orange-500 focus:outline-none transition duration-200"
                        placeholder="Exemple : Quel est le taux d'accès à l'électricité de 2015 à 2023 ?"></textarea>
                    <button 
                        id="searchBtn"
                        class="bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600 text-white font-semibold px-8 py-3 rounded-lg transition duration-200 transform hover:scale-105">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Rechercher
                    </button>
                </div>
                
                <!-- Examples -->
                <div class="mt-6">
                    <p class="text-sm text-gray-600 mb-2">Exemples de questions :</p>
                    <div class="flex flex-wrap gap-2">
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-full transition duration-200">
                            Accès à l'électricité 2015-2024
                        </button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-full transition duration-200">
                            Taux d'inflation 2018-2023
                        </button>
                        <button class="example-btn text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-full transition duration-200">
                            Population urbaine en 2020
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Analyse de votre question en cours...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden max-w-4xl mx-auto space-y-6">
            <!-- Message -->
            <div class="result-card bg-white rounded-2xl shadow-lg p-8">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-info-circle text-blue-500 text-2xl mt-1"></i>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Réponse</h3>
                        <p id="responseMessage" class="text-gray-700 leading-relaxed"></p>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div id="dataTableCard" class="result-card bg-white rounded-2xl shadow-lg p-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-table mr-2 text-green-500"></i>
                    Données
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Année</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Valeur</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Unité</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Chart -->
            <div id="chartCard" class="result-card bg-white rounded-2xl shadow-lg p-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-chart-area mr-2 text-purple-500"></i>
                    Graphique
                </h3>
                <canvas id="dataChart" class="w-full" style="max-height: 400px;"></canvas>
            </div>

            <!-- Source -->
            <div id="sourceCard" class="result-card bg-white rounded-2xl shadow-lg p-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-link mr-2 text-orange-500"></i>
                    Source
                </h3>
                <p id="sourceName" class="text-gray-700 mb-2"></p>
                <a id="sourceLink" href="#" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline text-sm">
                    <i class="fas fa-external-link-alt mr-1"></i>
                    Voir la source
                </a>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden max-w-4xl mx-auto">
            <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-8">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-exclamation-circle text-red-500 text-2xl mt-1"></i>
                    <div>
                        <h3 class="text-lg font-semibold text-red-800 mb-2">Je ne sais pas.</h3>
                        <p id="errorMessage" class="text-red-700"></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Catalog Modal -->
    <div id="catalogModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-orange-500 to-green-500 text-white p-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-list mr-2"></i>
                        Catalogue des indicateurs
                    </h2>
                    <button id="closeCatalogBtn" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition duration-200">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="mt-4">
                    <input 
                        id="catalogSearch" 
                        type="text" 
                        placeholder="Rechercher un indicateur..."
                        class="w-full px-4 py-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-white">
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6">
                <div id="catalogLoading" class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">Chargement du catalogue...</p>
                </div>
                <div id="catalogContent" class="hidden space-y-4">
                    <div id="catalogStats" class="bg-blue-50 rounded-lg p-4 mb-4">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-chart-bar mr-2"></i>
                            <span id="catalogCount">0</span> indicateur(s) trouvé(s)
                        </p>
                    </div>
                    <div id="catalogList" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentChart = null;
        let allIndicators = [];

        // Elements
        const queryInput = document.getElementById('queryInput');
        const searchBtn = document.getElementById('searchBtn');
        const loadingState = document.getElementById('loadingState');
        const resultsSection = document.getElementById('resultsSection');
        const errorState = document.getElementById('errorState');
        const catalogBtn = document.getElementById('catalogBtn');
        const catalogModal = document.getElementById('catalogModal');
        const closeCatalogBtn = document.getElementById('closeCatalogBtn');
        const catalogSearch = document.getElementById('catalogSearch');

        // Example buttons
        document.querySelectorAll('.example-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                queryInput.value = btn.textContent.trim();
                performSearch();
            });
        });

        // Search button
        searchBtn.addEventListener('click', performSearch);
        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                performSearch();
            }
        });

        // Catalog modal
        catalogBtn.addEventListener('click', openCatalog);
        closeCatalogBtn.addEventListener('click', closeCatalog);
        catalogModal.addEventListener('click', (e) => {
            if (e.target === catalogModal) closeCatalog();
        });
        catalogSearch.addEventListener('input', filterCatalog);

        async function performSearch() {
            const query = queryInput.value.trim();
            
            if (!query) {
                alert('Veuillez poser une question');
                return;
            }

            // Hide previous results
            resultsSection.classList.add('hidden');
            errorState.classList.add('hidden');
            
            // Show loading
            loadingState.classList.remove('hidden');

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();
                
                // Hide loading
                loadingState.classList.add('hidden');

                if (data.success) {
                    displayResults(data);
                } else {
                    displayError(data.message);
                }
            } catch (error) {
                loadingState.classList.add('hidden');
                displayError('Erreur lors de la communication avec le serveur.');
                console.error('Error:', error);
            }
        }

        function displayResults(data) {
            // Message
            document.getElementById('responseMessage').textContent = data.message;

            // Data table
            const tableBody = document.getElementById('dataTableBody');
            tableBody.innerHTML = '';
            
            data.data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700">${item.year}</td>
                    <td class="px-4 py-3 text-sm text-gray-700 font-semibold">${item.value.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${data.unit || '-'}</td>
                `;
                tableBody.appendChild(row);
            });

            // Chart
            createChart(data);

            // Source
            document.getElementById('sourceName').textContent = data.source || 'Source non disponible';
            const sourceLink = document.getElementById('sourceLink');
            if (data.source_link) {
                sourceLink.href = data.source_link;
                sourceLink.classList.remove('hidden');
            } else {
                sourceLink.classList.add('hidden');
            }

            // Show results
            resultsSection.classList.remove('hidden');
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function createChart(data) {
            const ctx = document.getElementById('dataChart');
            
            // Destroy previous chart
            if (currentChart) {
                currentChart.destroy();
            }

            const years = data.data.map(item => item.year);
            const values = data.data.map(item => item.value);

            currentChart = new Chart(ctx, {
                type: data.chart_type === 'bar' ? 'bar' : 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: data.indicator_name,
                        data: values,
                        borderColor: 'rgb(249, 115, 22)',
                        backgroundColor: data.chart_type === 'bar' 
                            ? 'rgba(249, 115, 22, 0.7)'
                            : 'rgba(249, 115, 22, 0.1)',
                        borderWidth: 2,
                        fill: data.chart_type !== 'bar',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: data.indicator_name,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: data.unit || 'Valeur'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Année'
                            }
                        }
                    }
                }
            });
        }

        function displayError(message) {
            document.getElementById('errorMessage').textContent = message;
            errorState.classList.remove('hidden');
            errorState.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function openCatalog() {
            catalogModal.classList.remove('hidden');
            document.getElementById('catalogLoading').classList.remove('hidden');
            document.getElementById('catalogContent').classList.add('hidden');

            if (allIndicators.length === 0) {
                try {
                    const response = await fetch('/api/indicators');
                    const data = await response.json();
                    
                    if (data.success) {
                        allIndicators = data.indicators;
                        renderCatalog(allIndicators);
                    }
                } catch (error) {
                    console.error('Error loading catalog:', error);
                }
            } else {
                renderCatalog(allIndicators);
            }

            document.getElementById('catalogLoading').classList.add('hidden');
            document.getElementById('catalogContent').classList.remove('hidden');
        }

        function renderCatalog(indicators) {
            const catalogList = document.getElementById('catalogList');
            const catalogCount = document.getElementById('catalogCount');
            
            catalogCount.textContent = indicators.length;
            catalogList.innerHTML = '';

            indicators.forEach(indicator => {
                const item = document.createElement('div');
                item.className = 'border border-gray-200 rounded-lg p-4 hover:border-orange-500 hover:shadow-md transition duration-200 cursor-pointer';
                item.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 mb-1">${indicator.name}</h4>
                            <p class="text-sm text-gray-600 mb-2">Code: <span class="font-mono text-blue-600">${indicator.code}</span></p>
                            ${indicator.unit ? `<p class="text-xs text-gray-500"><i class="fas fa-ruler mr-1"></i>Unité: ${indicator.unit}</p>` : ''}
                            ${indicator.source ? `<p class="text-xs text-gray-500"><i class="fas fa-database mr-1"></i>Source: ${indicator.source}</p>` : ''}
                        </div>
                        <button class="use-indicator-btn bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm transition duration-200" data-name="${indicator.name}">
                            <i class="fas fa-search mr-1"></i>Utiliser
                        </button>
                    </div>
                `;
                
                item.querySelector('.use-indicator-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    queryInput.value = indicator.name;
                    closeCatalog();
                });
                
                catalogList.appendChild(item);
            });
        }

        function filterCatalog() {
            const searchTerm = catalogSearch.value.toLowerCase();
            const filtered = allIndicators.filter(ind => 
                ind.name.toLowerCase().includes(searchTerm) ||
                ind.code.toLowerCase().includes(searchTerm)
            );
            renderCatalog(filtered);
        }

        function closeCatalog() {
            catalogModal.classList.add('hidden');
            catalogSearch.value = '';
        }
    </script>
</body>
</html>
